# 基于UDP的可靠传输协议
## 应用场景
+ 实时数据流传输  
    面向直播等场景，避免卡顿，需要低延迟可靠传输。
+ 文件同步传输  
    面向数据同步，文件交换等场景，传输大量数据，需要有效利用带宽。
## 需求分析
* 建立可靠稳定连接。  
* NAT穿透 保活/重绑定。  
* 加密传输。
* 连接复用。  
* 高性能。高带宽低延时，并提供机制来平衡带宽和延迟在不同应用场景下的需求。  
* 连接迁移   
* 广播和组播
* 传输路径优化，relay机制实现智能路由节点选择 (uuid标识提供了方便的迁移)

## 方案设计
+ 基于UDP进行数据传输
+ 对数据进行stream分组来实现同一connect上的多路复用。
+ 通过分组排序编号和重传机制，保证连接建立之后数据传输不丢失、不失序、不重复。
+ 通过心跳包维持连接不断开，NAT不失效。
+ 采用密钥交换握手以及对称加密对传输数据进行加密。
+ 基于带宽检测进行拥塞控制。
+ 通过滑动窗口协议实现流量控制。
+ 通过选择性重传(NACK)和前向错误纠正(FEC)来高带宽和低延迟的需求。
+ 通过uuid来替代ip+port标识连接，保证ip、端口变化连接不会断开，实现连接迁移。
+ RTT探测记录（一段时间内 最大 最小）
+ 定时器驱动的MTU探测（设置ip不分片，2倍RTT超时，不同大小的ping包探测）

### 应用接口
#### 传输配置
* 拥塞配置
* 重传配置
* 是否开启前向纠错
* 加密配置
#### 连接管理
* 握手和密钥交换
* 心跳 连接维持和NAT保持
* connect/stream操作
#### 代理
代理接口
#### 传输状态反馈
* 带宽状态
* 丢包状态
* 延迟状态
* 对端接收状态
为上层应用提供传输链路信息，以便在业务上根据反馈进行调整。如视频直播，检测到带宽下降是否需要降低清晰度保证流畅。

### 传输控制
#### 拥塞控制
公平 友好 可控 可配置
* BBR
* 参数调节 带宽采样周期(默认10个) RTT探测周期(默认10s) 丢包反馈(对路由器AQM机制做出反应)
#### 流量控制
* 接收窗口 
    接收方根据自身处理速度可设置接收窗口大小，反馈给发送方以控制发送速度，实现限流。极端情况下可将接受窗口设置为0进行熔断，待处理业务恢复后在开启。
* 发送窗口
    发送窗口大小受到拥塞控制和接收方反馈接收窗口的共同调节作用，控制数据发送速度。
#### 重传和前向纠错
* 选择性重传
* 快速重传
* 前向纠错
#### 加解密
* 非对称加密
    实现安全的密钥交换
* 对称加密
    用于传输数据的加密

### MTU探测
1. 定时器驱动
2. 发送设置不分片标志的currentMTU大小ping包
3. 是否收到ICMP "Destination Unreachable (Datagram Too Big)" message 是5 否4
4. 是否超时 是5 否7
5. 是否可以调整增量 是6 否8
6. 减小currentMTU
7. 更新maxMTU,增加currentMTU
8. 设置MTU

## 开源方案
### QUIC
QUIC (Quick UDP Internet Connection，快速UDP互联网连接)是Google提出基于UDP的多路复用的安全传输协议(chromium内开源实现)。  
QUIC提供了等价于HTTP/2的多路复用和流控，等价于TLS的安全机制，及等价于TCP的连接语义、可靠性和拥塞控制。
### KCP
KCP是一个快速可靠协议，能以比 TCP浪费10%-20%的带宽的代价，换取平均延迟降低 30%-40%，且最大延迟降低三倍的传输效果