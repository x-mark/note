# 基于UDP的高效可靠网络传输协议

## 需求
* 可靠稳定连接。连接建立之后保证数据传输不丢失、不失序、不重复，为上层应用提供透明可靠传输。连接建立后不易因干扰而意外关闭。
* NAT穿透 保活/重绑定。提供NAT穿透机制，并利用心跳包来维持连接不断开，因NAT原因发生变化后易于重绑定。
* 加密。传输过程加密。
* 连接复用。同一个connect可以承载来自应用的不同的stream，stream相互之间不干扰，减少不必要的连接开销。  
* 高性能。高带宽低延时，并提供机制来平衡带宽和延迟在不同应用场景下的需求。  
这需要：
    1. 灵活可控的拥塞控制方案，可插拔，针对不同应用需求可灵活调整。
    2. connect/stream级别的流控。
    3. 不同的丢包处理方案。选择性重传ARQ+前向错误纠正FEC  
* 连接迁移  
    ip或端口变化不会造成当前connect的关闭，不需要重新建立连接。

## 为什么不用TCP
* 性能
    + 延迟  
        TCP在以下阶段会带来延迟：
        - 建立连接时的多次握手。TCP建立连接采用三次握手机制，通常需要100ms以上。
        - 队头阻塞。TCP的ACK累积确认机制会造成前序分组未确认，后续分组全部阻塞，在连接复用场景下会阻塞其他stream。
        - 延迟发送。在发送数据量较小时，TCP的nagle算法会要求数据等待一段时间发送。
        - 延迟确认。延迟确认会使得接收端接收到分组数据后等待一段时间发送ACK，以实现多个ACK消息合并成一个。与延迟发送共同作用下写-写-读操作序列有可能会造成两端进入等待直到ACK延迟超时。
        - 慢启动。TCP的慢启动过程受初始窗口大小影响会照成一定的延迟(初始窗口小，吞吐低)，不能充分利用带宽。
        - 端口耗尽问题。TCP连接关闭再TIME_WAIT状态下会等待2MSL时间以尽可能的接收完数据，这段时间里端口不可用。
    + 带宽
        - TCP基于丢包的拥塞控制算法在高带宽高延迟网络(长肥网络)中无法充分利用带宽，一旦丢包带宽利用率下降严重。  
        - 全部重传机制造成的传输效率降低。  
* 拥塞控制  
    - 依赖于操作系统实现，更新升级缓慢。    
    - 算法本身局限性无法满足所有需求。  
    - 难于对特定场景的需求进行优化。  
    网络丢包的原因有：网络拥塞丢包，线路质量问题导致校验失败丢包，IP包传输乱序(网络乱序大于发送端阈值)造成误判丢包等。基于丢包的拥塞控制算法将丢包作为拥塞信号，将窗口减半进入慢启动过程进行拥塞控制在后两种情况下显然不太合理，降低了带宽利用率。
* 连接干扰  
    因为某些原因，TCP链接容易受到而导致连接断开(协议数据包明文header):
     + RST
     + SYN/ACK
     + FIN
* 重新连接
    TCP重新连接代价比较高：
    + 连接握手延迟
    + TIME_WAIT状态等待
    + ip和端口变化后如何识别重新连接(尤其是移动网络)
    
## 相关开源方案
1. KCP
	KCP的设计理念核心是追求低延迟，舍弃了一定的带宽利用率。
    + 基于UDP
    + ARQ可靠实现
    + 低延迟，牺牲一定带宽利用率 （浪费10%-20%带宽，平均降低30%-40%延迟）
        - RTO不翻倍 
            TCP的RTO丢包会进行翻倍处理，KCP是x1.5
        - 非累积ACK
        - 快速重传  
            支持快速重传，快速重传丢失的数据包
        - 选择性重传 
            只重传未收到的数据包
        - 可配置非延时ACK  
            可配置ACK不延时，TCP无法配置
        - 可配置非退让流控  
            牺牲公平性和带宽利用率，丢包窗口不退让，不进行慢启动
    + 实现简单  
        两个文件，1500行C代码规模

2. QUIC
    + Google设计开源 已提交IETF草案阶段 
    + 基于UDP
    + 传输层加密TLS
    + 低握手延迟
        1RTT新建连接，完成密钥交换 0RTT重新连接
    + 支持连接迁移
        使用uuid标识连接，端口、ip变化无影响
    + 支持多路复用，没有队头阻塞
        前一个数据包未到达，不会阻塞其他stream的后续数据包
    + 丢包处理
        - 前向错误纠正 FEC
            一定程度的丢包可恢复，延迟低。现在是XOR算法。
        - 选择性重传
            只重传丢失的数据包
    + 可插拔的拥塞控制
        - 拥塞控制算法可插拔，灵活配置。Cubic、Reno等TCP拥塞算法均有实现。同时QUIC也是早期google BBR算法的测试平台。
    + connect/stream流控
        - 支持connect/stream两级窗口流控
    + 相关应用：
        - Google youtube  
            页面加载速度平均提高5%  
            99%的网页搜索加快1s  
            youtube减少了30%的视频缓冲暂停    
            数据来源：  
            [IETF93 QUIC BarBoF: Protocol Overview](http://docs.google.com/presentation/d/15e1bLKYeN56GL1oTJSF9OZiUsI-rcxisLo9dEyDkWQs/edit#slide=id.g99041b54d_0_532)
        - 腾讯  
            页面加载时间提升约22%  
            数据来源：  
            [QUIC协议的分析，性能测试以及在QQ会员实践](https://zhuanlan.zhihu.com/p/37533709)   
            [让互联网更快的协议，QUIC在腾讯的实践及性能优化](https://zhuanlan.zhihu.com/p/32560981)  
        - 新浪微博  
            数据来源：  
            [QUIC在微博中的落地思考](http://www.infoq.com/cn/news/2018/03/weibo-quic)
        - 七牛云  
            卡顿率减少，流畅度提升。
            |ATC模拟网络环境|QUIC|TCP|
            |---|---|---|
            |delay 100ms loss 1%|卡顿0次流畅100%|卡顿247次流畅度55.32%|
            |delay 200ms loss 10%|卡顿35次流畅度87.22%|视频流断开| 
            数据来源：  
            [流畅度提高 100%！七牛云 QUIC 推流方案如何实现直播 0 卡顿？](https://zhuanlan.zhihu.com/p/33698793)